<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Choir Members</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2d3748;
            padding: 40px 0;
            margin: 20px 20px 40px 20px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .dashboard-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-header .lead {
            color: #718096;
            margin: 0;
        }

        .btn-light {
            background: white;
            color: #667eea;
            border: 2px solid transparent;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .btn-light:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-light {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .stats-card:hover::before {
            transform: scaleX(1);
        }

        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .stats-card p {
            color: #718096;
            margin: 0;
            font-weight: 500;
        }

        .search-filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
            background: #f7fafc;
            font-size: 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 14px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2, #667eea);
        }

        .member-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            margin-bottom: 25px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .member-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .member-card:hover::before {
            transform: scaleY(1);
        }

        .member-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #667eea, #764ba2) border-box;
            transition: all 0.3s ease;
        }

        .member-photo.missing {
            border-color: #f56565;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #f56565, #e53e3e) border-box;
        }

        .member-card:hover .member-photo {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .member-info h5 {
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .member-info p {
            color: #718096;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .member-info i {
            color: #667eea;
            width: 20px;
            margin-right: 8px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .badge-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .badge-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .badge-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .badge-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .badge-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 25px 30px;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-row {
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2d3748;
            font-size: 1.05rem;
        }

        .pagination {
            justify-content: center;
            margin-top: 30px;
        }

        .page-link {
            color: #667eea;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 0 5px;
            padding: 10px 18px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

        .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .print-only {
            display: none;
        }

        @media print {
            body {
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .member-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                background: white;
            }
            
            .dashboard-header {
                background: white;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.6rem;
            }
            
            .btn-light, .btn-outline-light {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px 0;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #718096;
        }

        .container {
            padding: 0 20px;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 15px;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            vertical-align: middle;
            border-color: #e2e8f0;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(102, 126, 234, 0.05);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: translateX(5px);
            transition: all 0.3s ease;
        }

        .modal-xl {
            max-width: 95%;
        }

        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .table th,
            .table td {
                padding: 8px 10px;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .photo-status {
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .photo-status.missing {
            color: #f56565;
        }

        .photo-status.exists {
            color: #48bb78;
        }

        /* Edit Modal Styles */
        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .form-text {
            font-size: 0.875rem;
            color: #718096;
        }

        .img-thumbnail {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 4px;
            max-height: 150px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-select[multiple] {
            height: auto;
            min-height: 120px;
        }

        .form-label.required:after {
            content: " *";
            color: #e53e3e;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 576px) {
            .export-buttons {
                flex-direction: column;
            }
            
            .export-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <h1><i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard</h1>
                    <p class="lead">Manage Choir Members</p>
                </div>
                <div class="col-md-6 text-md-end no-print">
                    <div class="export-buttons">
                        <a href="/" class="btn btn-light btn-lg">
                            <i class="fas fa-plus me-2"></i>New Registration
                        </a>
                        <button onclick="viewAllMembers()" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-list me-2"></i>View All
                        </button>
                        <button onclick="exportToPDF()" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-file-pdf me-2"></i>PDF
                        </button>
                        <button onclick="exportToCSV()" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-file-excel me-2"></i>Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="row no-print">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalMembers">0</h3>
                    <p>Total Members</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-music"></i>
                    <h3 id="activeMembers">0</h3>
                    <p>Current Year</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-church"></i>
                    <h3 id="totalParishes">0</h3>
                    <p>Parishes</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-flag"></i>
                    <h3 id="totalZones">0</h3>
                    <p>Zones</p>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-filter-section no-print">
            <div class="row">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by name, phone, or parish...">
                        <button class="btn btn-primary" onclick="searchMembers()">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterZone" onchange="filterByZone()">
                        <option value="">All Zones</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="checkImageStatus()">
                        <i class="fas fa-images me-2"></i>Check Photos
                    </button>
                </div>
            </div>
        </div>

        <!-- Members List -->
        <div id="membersContainer">
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No Members Yet</h3>
                <p>Start by adding new choir members using the registration form.</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav id="pagination" class="no-print">
            <!-- Pagination will be loaded here -->
        </nav>
    </div>

    <!-- Member Detail Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i>Member Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="memberDetails">
                    <!-- Member details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- View All Members Modal -->
    <div class="modal fade" id="viewAllModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>All Choir Members</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted" id="totalMembersCount">Loading...</span>
                        <div class="export-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="printAllMembers()">
                                <i class="fas fa-print me-1"></i>Print
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-1"></i>PDF
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportToCSV()">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="allMembersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Photo</th>
                                    <th>Full Name</th>
                                    <th>Phone</th>
                                    <th>Zone</th>
                                    <th>Area</th>
                                    <th>Parish</th>
                                    <th>Voice Part</th>
                                    <th>Year Joined</th>
                                    <th>Gender</th>
                                    <th>Occupation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allMembersTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const limit = 10;
        let allMembers = [];
        let isExporting = false;

        document.addEventListener('DOMContentLoaded', function() {
            loadMembers();
            loadZones();
            setupSearch();
            setupFileValidation();
        });

        // Load members with pagination
        async function loadMembers(page = 1) {
            try {
                currentPage = page;
                const response = await fetch(`/api/members?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                allMembers = data.members;
                displayMembers(allMembers);
                displayPagination(data.pagination);
                updateStats(data.pagination.totalMembers);
            } catch (error) {
                console.error('Error loading members:', error);
                showError('Failed to load members');
            }
        }

        // Display members in the dashboard
        function displayMembers(members) {
            const container = document.getElementById('membersContainer');
            
            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users fa-4x text-muted mb-3"></i>
                        <h3>No Members Found</h3>
                        <p class="text-muted">No choir members match your search criteria.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = members.map(member => {
                const hasPhoto = member.photo && member.photo.trim() !== '';
                const photoUrl = hasPhoto ? `/uploads/${member.photo}` : '';
                const photoId = `photo-${member._id}`;
                const statusId = `status-${member._id}`;
                
                return `
                    <div class="member-card">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center mb-3 mb-md-0">
                                ${hasPhoto ? 
                                    `<img src="${photoUrl}" class="member-photo" alt="${member.fullName}" 
                                         id="${photoId}"
                                         onerror="markPhotoMissing('${member._id}', '${member.fullName}')">` :
                                    `<div class="member-photo bg-light d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="fas fa-user text-muted fa-2x"></i>
                                    </div>`
                                }
                                <div class="photo-status ${hasPhoto ? 'exists' : 'missing'}" id="${statusId}">
                                    ${hasPhoto ? 'Photo available' : 'No photo'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="member-info">
                                    <h5>${member.fullName}</h5>
                                    <p><i class="fas fa-phone"></i>${member.phoneNo}</p>
                                    <p><i class="fas fa-church"></i>${member.parish}</p>
                                    <p><i class="fas fa-map-marker-alt"></i>${member.zone} - ${member.area}</p>
                                    <p><i class="fas fa-music"></i>${member.part} â€¢ Joined: ${member.joinYear}</p>
                                    <div class="mt-2">
                                        ${member.position && member.position.length > 0 ? 
                                            member.position.map(pos => `<span class="badge badge-primary me-1">${pos}</span>`).join('') : 
                                            '<span class="badge badge-secondary">No Position</span>'
                                        }
                                        ${member.instruments && member.instruments.length > 0 ? 
                                            member.instruments.map(instr => `<span class="badge badge-success me-1">${instr}</span>`).join('') : 
                                            ''
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <button class="btn btn-outline-primary btn-sm mb-1" onclick="viewMemberDetails('${member._id}')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <button class="btn btn-outline-warning btn-sm mb-1" onclick="editMember('${member._id}')">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm mb-1" onclick="deleteMember('${member._id}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="printMember('${member._id}')">
                                    <i class="fas fa-print me-1"></i>Print
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Enhanced PDF Export function
        async function exportToPDF() {
            if (isExporting) return;
            
            try {
                isExporting = true;
                const exportBtn = document.querySelector('button[onclick="exportToPDF()"]');
                const originalText = exportBtn.innerHTML;
                
                // Show loading state
                exportBtn.innerHTML = '<div class="loading-spinner me-2"></div> Generating PDF...';
                exportBtn.disabled = true;
                
                showToast('Generating PDF with all member details and photos...', 'info');
                
                // Use the enhanced PDF endpoint
                const response = await fetch('/api/members/export/pdf');
                
                if (!response.ok) {
                    throw new Error(`PDF generation failed: ${response.statusText}`);
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `choir-members-${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('PDF generated successfully! Download started.');
                
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                showError('Failed to generate PDF: ' + error.message);
            } finally {
                isExporting = false;
                // Restore button state
                const exportBtn = document.querySelector('button[onclick="exportToPDF()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = '<i class="fas fa-file-pdf me-2"></i>PDF';
                    exportBtn.disabled = false;
                }
            }
        }

        // Enhanced CSV Export function
        async function exportToCSV() {
            if (isExporting) return;
            
            try {
                isExporting = true;
                const exportBtn = document.querySelector('button[onclick="exportToCSV()"]');
                const originalText = exportBtn.innerHTML;
                
                // Show loading state
                exportBtn.innerHTML = '<div class="loading-spinner me-2"></div> Generating CSV...';
                exportBtn.disabled = true;
                
                showToast('Generating CSV with complete member information...', 'info');
                
                const response = await fetch('/api/members/export/csv');
                
                if (!response.ok) {
                    throw new Error(`CSV generation failed: ${response.statusText}`);
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `choir-members-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('CSV generated successfully! Download started.');
                
            } catch (error) {
                console.error('Error exporting to CSV:', error);
                showError('Failed to generate CSV: ' + error.message);
            } finally {
                isExporting = false;
                // Restore button state
                const exportBtn = document.querySelector('button[onclick="exportToCSV()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = '<i class="fas fa-file-excel me-2"></i>Excel';
                    exportBtn.disabled = false;
                }
            }
        }

        // Mark photo as missing when image fails to load
        function markPhotoMissing(memberId, memberName) {
            const photoElement = document.getElementById(`photo-${memberId}`);
            const statusElement = document.getElementById(`status-${memberId}`);
            
            if (photoElement) {
                photoElement.style.display = 'none';
            }
            
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Photo missing';
                statusElement.className = 'photo-status missing';
            }
            
            console.warn(`Photo missing for member: ${memberName}`);
        }

        // Display pagination
        function displayPagination(pagination) {
            const paginationContainer = document.getElementById('pagination');
            
            if (pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <ul class="pagination justify-content-center">
            `;
            
            // Previous button
            if (pagination.hasPrev) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMembers(${pagination.currentPage - 1})">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                `;
            }
            
            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, pagination.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadMembers(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            if (pagination.hasNext) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMembers(${pagination.currentPage + 1})">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;
            }
            
            paginationHTML += `</ul>`;
            paginationContainer.innerHTML = paginationHTML;
        }

        // Update statistics
        async function updateStats(totalMembers) {
            try {
                document.getElementById('totalMembers').textContent = totalMembers;
                
                const currentYear = new Date().getFullYear();
                const response = await fetch('/api/members/all');
                const data = await response.json();
                
                if (data.success) {
                    const members = data.members;
                    const currentYearMembers = members.filter(m => m.joinYear == currentYear).length;
                    document.getElementById('activeMembers').textContent = currentYearMembers;
                    
                    const uniqueParishes = [...new Set(members.map(m => m.parish))].length;
                    document.getElementById('totalParishes').textContent = uniqueParishes;
                    
                    const uniqueZones = [...new Set(members.map(m => m.zone))].length;
                    document.getElementById('totalZones').textContent = uniqueZones;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Load zones for filter
        async function loadZones() {
            try {
                const response = await fetch('/api/zones');
                const zones = await response.json();
                const filterZone = document.getElementById('filterZone');
                
                zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    filterZone.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading zones:', error);
            }
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchMembers, 500);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMembers();
                }
            });
        }

        async function searchMembers() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const filterZone = document.getElementById('filterZone').value;
            
            if (searchTerm === '' && filterZone === '') {
                loadMembers();
                return;
            }
            
            try {
                let members = allMembers;
                
                // Apply zone filter
                if (filterZone) {
                    members = members.filter(m => m.zone === filterZone);
                }
                
                // Apply search term
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    members = members.filter(m => 
                        m.fullName.toLowerCase().includes(searchLower) ||
                        m.phoneNo.includes(searchTerm) ||
                        m.parish.toLowerCase().includes(searchLower) ||
                        m.zone.toLowerCase().includes(searchLower) ||
                        m.area.toLowerCase().includes(searchLower)
                    );
                }
                
                displayMembers(members);
                
                // Hide pagination during filtered search
                document.getElementById('pagination').innerHTML = '';
            } catch (error) {
                console.error('Error searching members:', error);
            }
        }

        // View member details
        async function viewMemberDetails(memberId) {
            try {
                const response = await fetch(`/api/members/${memberId}`);
                const data = await response.json();
                
                if (data.success) {
                    const member = data.member;
                    const modalBody = document.getElementById('memberDetails');
                    
                    const photoHtml = member.photo ? 
                        `<img src="/uploads/${member.photo}" style="width: 200px; height: 200px; border-radius: 50%; border: 4px solid #667eea; object-fit: cover;" 
                              alt="${member.fullName}"
                              onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbxlIiBkeT0iLjNlbSI+UGhvdG8gTm90IEZvdW5kPC90ZXh0Pjwvc3ZnPg==';">` :
                        `<div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 200px; height: 200px; border: 4px solid #667eea;">
                            <i class="fas fa-user fa-4x text-muted"></i>
                        </div>`;
                    
                    modalBody.innerHTML = `
                        <div class="text-center mb-4">
                            ${photoHtml}
                            <h4 class="mt-3">${member.fullName}</h4>
                            <p class="text-muted">${member.occupation}</p>
                            ${!member.photo ? '<p class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>No photo uploaded</p>' : ''}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-user-circle me-2"></i>Personal Information</h5>
                                <div class="detail-row">
                                    <div class="detail-label">Full Name</div>
                                    <div class="detail-value">${member.fullName}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Gender</div>
                                    <div class="detail-value">${member.gender}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Marital Status</div>
                                    <div class="detail-value">${member.status}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">State of Origin</div>
                                    <div class="detail-value">${member.stateOfOrigin}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Home Town</div>
                                    <div class="detail-value">${member.homeTown}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Occupation</div>
                                    <div class="detail-value">${member.occupation}</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5><i class="fas fa-church me-2"></i>Church Information</h5>
                                <div class="detail-row">
                                    <div class="detail-label">Zone</div>
                                    <div class="detail-value">${member.zone}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Area</div>
                                    <div class="detail-value">${member.area}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Parish</div>
                                    <div class="detail-value">${member.parish}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Parish Address</div>
                                    <div class="detail-value">${member.parishAddress}</div>
                                </div>
                                
                                <h5 class="mt-4"><i class="fas fa-music me-2"></i>Choir Information</h5>
                                <div class="detail-row">
                                    <div class="detail-label">Voice Part</div>
                                    <div class="detail-value">${member.part}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Year Joined</div>
                                    <div class="detail-value">${member.joinYear}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Positions</div>
                                    <div class="detail-value">${member.position && member.position.length > 0 ? member.position.join(', ') : 'None'}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Instruments</div>
                                    <div class="detail-value">${member.instruments && member.instruments.length > 0 ? member.instruments.join(', ') : 'None'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5><i class="fas fa-address-card me-2"></i>Contact Information</h5>
                                <div class="detail-row">
                                    <div class="detail-label">Phone Number</div>
                                    <div class="detail-value">${member.phoneNo}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Residential Address</div>
                                    <div class="detail-value">${member.residentialAddress}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('memberModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading member details:', error);
                showError('Failed to load member details');
            }
        }

        // Edit member - opens modal with form
        async function editMember(memberId) {
            try {
                const response = await fetch(`/api/members/${memberId}`);
                const data = await response.json();
                
                if (data.success) {
                    openEditModal(data.member);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading member for edit:', error);
                showError('Failed to load member for editing: ' + error.message);
            }
        }

        // Open edit modal with member data
        function openEditModal(member) {
            const modalBody = `
                <form id="editMemberForm" enctype="multipart/form-data">
                    <input type="hidden" name="memberId" value="${member._id}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-user-circle me-2"></i>Personal Information</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Current Photo</label>
                                <div class="text-center mb-3">
                                    ${member.photo ? 
                                        `<img src="/uploads/${member.photo}" class="img-thumbnail" style="max-height: 150px;"
                                              onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y3ZjdmNyIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+UGhvdG8gTm90IEZvdW5kPC90ZXh0Pjwvc3ZnPg==';">` :
                                        `<div class="bg-light rounded d-inline-flex align-items-center justify-content-center p-4">
                                            <i class="fas fa-user fa-3x text-muted"></i>
                                        </div>`
                                    }
                                </div>
                                <label class="form-label">Upload New Photo</label>
                                <input type="file" class="form-control" name="photo" accept="image/*">
                                <div class="form-text">Max file size: 5MB. Supported formats: JPG, PNG, GIF</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label required">Full Name</label>
                                <input type="text" class="form-control" name="fullName" value="${member.fullName || ''}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label required">Gender</label>
                                <select class="form-select" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male" ${member.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${member.gender === 'Female' ? 'selected' : ''}>Female</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Marital Status</label>
                                <select class="form-select" name="status">
                                    <option value="">Select Status</option>
                                    <option value="Single" ${member.status === 'Single' ? 'selected' : ''}>Single</option>
                                    <option value="Married" ${member.status === 'Married' ? 'selected' : ''}>Married</option>
                                    <option value="Divorced" ${member.status === 'Divorced' ? 'selected' : ''}>Divorced</option>
                                    <option value="Widowed" ${member.status === 'Widowed' ? 'selected' : ''}>Widowed</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">State of Origin</label>
                                <input type="text" class="form-control" name="stateOfOrigin" value="${member.stateOfOrigin || ''}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Home Town</label>
                                <input type="text" class="form-control" name="homeTown" value="${member.homeTown || ''}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Occupation</label>
                                <input type="text" class="form-control" name="occupation" value="${member.occupation || ''}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5><i class="fas fa-church me-2"></i>Church Information</h5>
                            
                            <div class="mb-3">
                                <label class="form-label required">Zone</label>
                                <input type="text" class="form-control" name="zone" value="${member.zone || ''}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Area</label>
                                <input type="text" class="form-control" name="area" value="${member.area || ''}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label required">Parish</label>
                                <input type="text" class="form-control" name="parish" value="${member.parish || ''}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Parish Address</label>
                                <textarea class="form-control" name="parishAddress" rows="2">${member.parishAddress || ''}</textarea>
                            </div>

                            <h5 class="mt-4"><i class="fas fa-music me-2"></i>Choir Information</h5>
                            
                            <div class="mb-3">
                                <label class="form-label required">Voice Part</label>
                                <select class="form-select" name="part" required>
                                    <option value="">Select Voice Part</option>
                                    <option value="Soprano" ${member.part === 'Soprano' ? 'selected' : ''}>Soprano</option>
                                    <option value="Alto" ${member.part === 'Alto' ? 'selected' : ''}>Alto</option>
                                    <option value="Tenor" ${member.part === 'Tenor' ? 'selected' : ''}>Tenor</option>
                                    <option value="Bass" ${member.part === 'Bass' ? 'selected' : ''}>Bass</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label required">Year Joined</label>
                                <input type="number" class="form-control" name="joinYear" value="${member.joinYear || new Date().getFullYear()}" min="2000" max="2030" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Positions</label>
                                <select class="form-select" name="position" multiple>
                                    <option value="Choir Master" ${member.position && member.position.includes('Choir Master') ? 'selected' : ''}>Choir Master</option>
                                    <option value="Assistant Choir Master" ${member.position && member.position.includes('Assistant Choir Master') ? 'selected' : ''}>Assistant Choir Master</option>
                                    <option value="Secretary" ${member.position && member.position.includes('Secretary') ? 'selected' : ''}>Secretary</option>
                                    <option value="Treasurer" ${member.position && member.position.includes('Treasurer') ? 'selected' : ''}>Treasurer</option>
                                    <option value="Section Leader" ${member.position && member.position.includes('Section Leader') ? 'selected' : ''}>Section Leader</option>
                                </select>
                                <div class="form-text">Hold Ctrl/Cmd to select multiple positions</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Instruments</label>
                                <select class="form-select" name="instruments" multiple>
                                    <option value="Piano" ${member.instruments && member.instruments.includes('Piano') ? 'selected' : ''}>Piano</option>
                                    <option value="Organ" ${member.instruments && member.instruments.includes('Organ') ? 'selected' : ''}>Organ</option>
                                    <option value="Guitar" ${member.instruments && member.instruments.includes('Guitar') ? 'selected' : ''}>Guitar</option>
                                    <option value="Drums" ${member.instruments && member.instruments.includes('Drums') ? 'selected' : ''}>Drums</option>
                                    <option value="Violin" ${member.instruments && member.instruments.includes('Violin') ? 'selected' : ''}>Violin</option>
                                    <option value="Saxophone" ${member.instruments && member.instruments.includes('Saxophone') ? 'selected' : ''}>Saxophone</option>
                                </select>
                                <div class="form-text">Hold Ctrl/Cmd to select multiple instruments</div>
                            </div>

                            <h5 class="mt-4"><i class="fas fa-address-card me-2"></i>Contact Information</h5>
                            
                            <div class="mb-3">
                                <label class="form-label required">Phone Number</label>
                                <input type="tel" class="form-control" name="phoneNo" value="${member.phoneNo || ''}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Residential Address</label>
                                <textarea class="form-control" name="residentialAddress" rows="3">${member.residentialAddress || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Update Member
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            `;

            // Create or update modal
            let editModal = document.getElementById('editMemberModal');
            if (!editModal) {
                editModal = document.createElement('div');
                editModal.className = 'modal fade';
                editModal.id = 'editMemberModal';
                editModal.innerHTML = `
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Member</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="editMemberModalBody">
                                ${modalBody}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(editModal);
            } else {
                document.getElementById('editMemberModalBody').innerHTML = modalBody;
            }

            // Initialize modal
            const modal = new bootstrap.Modal(editModal);
            modal.show();

            // Add form submit handler
            document.getElementById('editMemberForm').addEventListener('submit', handleEditFormSubmit);
        }

        // Handle edit form submission
        async function handleEditFormSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const memberId = formData.get('memberId');
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            try {
                // Show loading state
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                submitButton.disabled = true;
                
                const response = await fetch(`/api/members/${memberId}`, {
                    method: 'PUT',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Member updated successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editMemberModal'));
                    modal.hide();
                    
                    // Refresh members list
                    loadMembers(currentPage);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error updating member:', error);
                showError('Failed to update member: ' + error.message);
            } finally {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        }

        // Delete member
        async function deleteMember(memberId) {
            if (!confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/members/${memberId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Member deleted successfully!');
                    loadMembers(currentPage);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error deleting member:', error);
                showError('Failed to delete member: ' + error.message);
            }
        }

        // Print member
        function printMember(memberId) {
            window.open(`/api/members/${memberId}?print=true`, '_blank');
        }

        // Check image status for all members
        async function checkImageStatus() {
            try {
                showToast('Checking photo status for all members...', 'info');
                
                const response = await fetch('/api/members/all');
                const data = await response.json();
                
                if (data.success) {
                    const members = data.members;
                    let missingPhotos = 0;
                    let hasPhotos = 0;
                    
                    // Check each member's photo
                    for (const member of members) {
                        if (member.photo && member.photo.trim() !== '') {
                            const img = new Image();
                            img.onload = function() {
                                hasPhotos++;
                            };
                            img.onerror = function() {
                                missingPhotos++;
                            };
                            img.src = `/uploads/${member.photo}`;
                        } else {
                            missingPhotos++;
                        }
                    }
                    
                    // Wait a moment for image checks to complete
                    setTimeout(() => {
                        showToast(`Photo Status: ${hasPhotos} with photos, ${missingPhotos} missing photos`, 'info');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error checking image status:', error);
                showError('Failed to check photo status');
            }
        }

        // Filter by zone
        function filterByZone() {
            searchMembers();
        }

        // Setup file validation
        function setupFileValidation() {
            document.addEventListener('change', function(e) {
                if (e.target.name === 'photo' && e.target.type === 'file') {
                    validateFile(e.target);
                }
            });
        }

        // File validation function
        function validateFile(input) {
            const file = input.files[0];
            if (!file) return true;
            
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (!validTypes.includes(file.type)) {
                showError('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                input.value = '';
                return false;
            }
            
            if (file.size > maxSize) {
                showError('File size must be less than 5MB');
                input.value = '';
                return false;
            }
            
            return true;
        }

        // View all members in table format
        async function viewAllMembers() {
            try {
                const response = await fetch('/api/members/all');
                const data = await response.json();
                
                if (data.success) {
                    const members = data.members;
                    const tableBody = document.getElementById('allMembersTableBody');
                    const totalCount = document.getElementById('totalMembersCount');
                    
                    totalCount.textContent = `Total Members: ${members.length}`;
                    
                    tableBody.innerHTML = members.map((member, index) => {
                        const photoCell = member.photo ? 
                            `<img src="/uploads/${member.photo}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" 
                                  alt="${member.fullName}"
                                  onerror="this.style.display='none'">` :
                            `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-user text-muted"></i>
                            </div>`;
                        
                        return `
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${photoCell}</td>
                                <td><strong>${member.fullName}</strong></td>
                                <td>${member.phoneNo}</td>
                                <td>${member.zone}</td>
                                <td>${member.area}</td>
                                <td>${member.parish}</td>
                                <td><span class="badge badge-primary">${member.part}</span></td>
                                <td>${member.joinYear}</td>
                                <td>${member.gender}</td>
                                <td>${member.occupation}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetails('${member._id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning mx-1" onclick="editMember('${member._id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member._id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    const modal = new bootstrap.Modal(document.getElementById('viewAllModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading all members:', error);
                showError('Failed to load all members');
            }
        }

        // Print all members in table format
        function printAllMembers() {
            const printWindow = window.open('', '_blank');
            const membersTable = document.getElementById('allMembersTable').cloneNode(true);
            
            // Remove action buttons from print version
            const actionCells = membersTable.querySelectorAll('td:last-child');
            actionCells.forEach(cell => cell.remove());
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Choir Members Report</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            line-height: 1.6;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 2px solid #333; 
                            padding-bottom: 20px; 
                        }
                        .header h1 { 
                            color: #333; 
                            margin: 0; 
                            font-size: 24px;
                        }
                        .header p { 
                            color: #666; 
                            margin: 5px 0; 
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            font-size: 14px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            text-align: left;
                        }
                        th {
                            background-color: #667eea;
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .badge {
                            background: #667eea;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 12px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>CHOIR MEMBERS REPORT</h1>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                        <p>Total Members: ${document.getElementById('allMembersTableBody').children.length}</p>
                    </div>
                    ${membersTable.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMembers();
            }
        });

        // Utility functions
        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>