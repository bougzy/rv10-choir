<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Choir Members</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #2d3748;
            padding: 40px 0;
            margin: 20px 20px 40px 20px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .dashboard-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-header .lead {
            color: #718096;
            margin: 0;
        }

        .btn-light {
            background: white;
            color: #667eea;
            border: 2px solid transparent;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .btn-light:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-light {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .stats-card:hover::before {
            transform: scaleX(1);
        }

        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .stats-card p {
            color: #718096;
            margin: 0;
            font-weight: 500;
        }

        .search-filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
            background: #f7fafc;
            font-size: 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 14px 30px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2, #667eea);
        }

        .member-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            margin-bottom: 25px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .member-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .member-card:hover::before {
            transform: scaleY(1);
        }

        .member-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #667eea, #764ba2) border-box;
            transition: all 0.3s ease;
        }

        .member-card:hover .member-photo {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .member-info h5 {
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .member-info p {
            color: #718096;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .member-info i {
            color: #667eea;
            width: 20px;
            margin-right: 8px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .badge-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .badge-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .badge-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .badge-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 25px 30px;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-row {
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2d3748;
            font-size: 1.05rem;
        }

        .pagination {
            justify-content: center;
            margin-top: 30px;
        }

        .page-link {
            color: #667eea;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 0 5px;
            padding: 10px 18px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

        .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .print-only {
            display: none;
        }

        @media print {
            body {
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .member-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                background: white;
            }
            
            .dashboard-header {
                background: white;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.6rem;
            }
            
            .btn-light, .btn-outline-light {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px 0;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #718096;
        }

        .container {
            padding: 0 20px;
        }

        .table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.table th {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 15px;
    font-weight: 600;
}

.table td {
    padding: 12px 15px;
    vertical-align: middle;
    border-color: #e2e8f0;
}

.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(102, 126, 234, 0.05);
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.1);
    transform: translateX(5px);
    transition: all 0.3s ease;
}

.modal-xl {
    max-width: 95%;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .table th,
    .table td {
        padding: 8px 10px;
    }
}
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <h1><i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard</h1>
                    <p class="lead">Manage Choir Members</p>
                </div>
                <!-- <div class="col-md-6 text-md-end no-print">
                    <a href="/" class="btn btn-light btn-lg">
                        <i class="fas fa-plus me-2"></i>New Registration
                    </a>
                    <button onclick="window.print()" class="btn btn-outline-light btn-lg ms-md-2">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                </div>
            </div> -->
            <div class="col-md-6 text-md-end no-print">
    <a href="/" class="btn btn-light btn-lg">
        <i class="fas fa-plus me-2"></i>New Registration
    </a>
    <button onclick="viewAllMembers()" class="btn btn-outline-light btn-lg ms-md-2">
        <i class="fas fa-list me-2"></i>View All
    </button>
    <button onclick="exportToPDF()" class="btn btn-outline-light btn-lg ms-md-2">
        <i class="fas fa-file-pdf me-2"></i>PDF
    </button>
    <button onclick="exportToCSV()" class="btn btn-outline-light btn-lg ms-md-2">
        <i class="fas fa-file-excel me-2"></i>Excel
    </button>
</div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="row no-print">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalMembers">0</h3>
                    <p>Total Members</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-music"></i>
                    <h3 id="activeMembers">0</h3>
                    <p>Current Year</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-church"></i>
                    <h3 id="totalParishes">0</h3>
                    <p>Parishes</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <i class="fas fa-flag"></i>
                    <h3 id="totalZones">0</h3>
                    <p>Zones</p>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-filter-section no-print">
            <div class="row">
                <div class="col-md-8 mb-3 mb-md-0">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by name, phone, or parish...">
                        <button class="btn btn-primary" onclick="searchMembers()">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="filterZone" onchange="loadMembers()">
                        <option value="">All Zones</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Members List -->
        <div id="membersContainer">
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No Members Yet</h3>
                <p>Start by adding new choir members using the registration form.</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav id="pagination" class="no-print">
            <!-- Pagination will be loaded here -->
        </nav>
    </div>

    <!-- Member Detail Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i>Member Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="memberDetails">
                    <!-- Member details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- View All Members Modal -->
<div class="modal fade" id="viewAllModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users me-2"></i>All Choir Members</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted" id="totalMembersCount">Loading...</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="printAllMembers()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="exportToCSV()">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="allMembersTable">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Full Name</th>
                                <th>Phone</th>
                                <th>Zone</th>
                                <th>Area</th>
                                <th>Parish</th>
                                <th>Voice Part</th>
                                <th>Year Joined</th>
                                <th>Gender</th>
                                <th>Occupation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allMembersTableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 1;
    const limit = 10;
    let allMembers = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadMembers();
        loadZones();
        setupSearch();
    });

    // Load members with pagination
    async function loadMembers(page = 1) {
        try {
            currentPage = page;
            const response = await fetch(`/api/members?page=${page}&limit=${limit}`);
            const data = await response.json();
            
            allMembers = data.members;
            displayMembers(allMembers);
            displayPagination(data.pagination);
            updateStats(data.pagination.totalMembers);
        } catch (error) {
            console.error('Error loading members:', error);
            showError('Failed to load members');
        }
    }

    // Display members in the dashboard
    function displayMembers(members) {
        const container = document.getElementById('membersContainer');
        
        if (members.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users fa-4x text-muted mb-3"></i>
                    <h3>No Members Found</h3>
                    <p class="text-muted">No choir members match your search criteria.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = members.map(member => `
            <div class="member-card">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center mb-3 mb-md-0">
                        ${member.photo ? 
                            `<img src="/uploads/${member.photo}" class="member-photo" alt="${member.fullName}">` :
                            `<div class="member-photo bg-light d-flex align-items-center justify-content-center rounded-circle">
                                <i class="fas fa-user text-muted fa-2x"></i>
                            </div>`
                        }
                    </div>
                    <div class="col-md-6">
                        <div class="member-info">
                            <h5>${member.fullName}</h5>
                            <p><i class="fas fa-phone"></i>${member.phoneNo}</p>
                            <p><i class="fas fa-church"></i>${member.parish}</p>
                            <p><i class="fas fa-map-marker-alt"></i>${member.zone} - ${member.area}</p>
                            <p><i class="fas fa-music"></i>${member.part} • Joined: ${member.joinYear}</p>
                            <div class="mt-2">
                                ${member.position && member.position.length > 0 ? 
                                    member.position.map(pos => `<span class="badge badge-primary me-1">${pos}</span>`).join('') : 
                                    '<span class="badge badge-secondary">No Position</span>'
                                }
                                ${member.instruments && member.instruments.length > 0 ? 
                                    member.instruments.map(instr => `<span class="badge badge-success me-1">${instr}</span>`).join('') : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-outline-primary btn-sm mb-1" onclick="viewMemberDetails('${member._id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        <button class="btn btn-outline-warning btn-sm mb-1" onclick="editMember('${member._id}')">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-outline-danger btn-sm mb-1" onclick="deleteMember('${member._id}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="printMember('${member._id}')">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Display pagination
    function displayPagination(pagination) {
        const paginationContainer = document.getElementById('pagination');
        
        if (pagination.totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }
        
        let paginationHTML = `
            <ul class="pagination justify-content-center">
        `;
        
        // Previous button
        if (pagination.hasPrev) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadMembers(${pagination.currentPage - 1})">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
            `;
        }
        
        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, pagination.currentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
        
        if (endPage - startPage + 1 < maxPages) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadMembers(${i})">${i}</a>
                </li>
            `;
        }
        
        // Next button
        if (pagination.hasNext) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadMembers(${pagination.currentPage + 1})">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
        }
        
        paginationHTML += `</ul>`;
        paginationContainer.innerHTML = paginationHTML;
    }

    // Update statistics
    async function updateStats(totalMembers) {
        try {
            document.getElementById('totalMembers').textContent = totalMembers;
            
            const currentYear = new Date().getFullYear();
            const response = await fetch('/api/members?limit=1000');
            const data = await response.json();
            const members = data.members;
            
            const currentYearMembers = members.filter(m => m.joinYear == currentYear).length;
            document.getElementById('activeMembers').textContent = currentYearMembers;
            
            const uniqueParishes = [...new Set(members.map(m => m.parish))].length;
            document.getElementById('totalParishes').textContent = uniqueParishes;
            
            const uniqueZones = [...new Set(members.map(m => m.zone))].length;
            document.getElementById('totalZones').textContent = uniqueZones;
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }

    // Load zones for filter
    async function loadZones() {
        try {
            const response = await fetch('/api/zones');
            const zones = await response.json();
            const filterZone = document.getElementById('filterZone');
            
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                filterZone.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading zones:', error);
        }
    }

    // Search functionality
    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchMembers, 500);
        });
    }

    async function searchMembers() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        const filterZone = document.getElementById('filterZone').value;
        
        if (searchTerm === '' && filterZone === '') {
            loadMembers();
            return;
        }
        
        try {
            let members = allMembers;
            
            // Apply zone filter
            if (filterZone) {
                members = members.filter(m => m.zone === filterZone);
            }
            
            // Apply search term
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                members = members.filter(m => 
                    m.fullName.toLowerCase().includes(searchLower) ||
                    m.phoneNo.includes(searchTerm) ||
                    m.parish.toLowerCase().includes(searchLower) ||
                    m.zone.toLowerCase().includes(searchLower) ||
                    m.area.toLowerCase().includes(searchLower)
                );
            }
            
            displayMembers(members);
            
            // Hide pagination during filtered search
            document.getElementById('pagination').innerHTML = '';
        } catch (error) {
            console.error('Error searching members:', error);
        }
    }

    // View member details
    async function viewMemberDetails(memberId) {
        try {
            const response = await fetch(`/api/members/${memberId}`);
            const data = await response.json();
            
            if (data.success) {
                const member = data.member;
                const modalBody = document.getElementById('memberDetails');
                modalBody.innerHTML = `
                    <div class="text-center mb-4">
                        ${member.photo ? 
                            `<img src="/uploads/${member.photo}" style="width: 200px; height: 200px; border-radius: 50%; border: 4px solid #667eea; object-fit: cover;" alt="${member.fullName}">` :
                            `<div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 200px; height: 200px; border: 4px solid #667eea;">
                                <i class="fas fa-user fa-4x text-muted"></i>
                            </div>`
                        }
                        <h4 class="mt-3">${member.fullName}</h4>
                        <p class="text-muted">${member.occupation}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-user-circle me-2"></i>Personal Information</h5>
                            <div class="detail-row">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${member.fullName}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Gender</div>
                                <div class="detail-value">${member.gender}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Marital Status</div>
                                <div class="detail-value">${member.status}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">State of Origin</div>
                                <div class="detail-value">${member.stateOfOrigin}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Home Town</div>
                                <div class="detail-value">${member.homeTown}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Occupation</div>
                                <div class="detail-value">${member.occupation}</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5><i class="fas fa-church me-2"></i>Church Information</h5>
                            <div class="detail-row">
                                <div class="detail-label">Zone</div>
                                <div class="detail-value">${member.zone}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Area</div>
                                <div class="detail-value">${member.area}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Parish</div>
                                <div class="detail-value">${member.parish}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Parish Address</div>
                                <div class="detail-value">${member.parishAddress}</div>
                            </div>
                            
                            <h5 class="mt-4"><i class="fas fa-music me-2"></i>Choir Information</h5>
                            <div class="detail-row">
                                <div class="detail-label">Voice Part</div>
                                <div class="detail-value">${member.part}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Year Joined</div>
                                <div class="detail-value">${member.joinYear}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Positions</div>
                                <div class="detail-value">${member.position && member.position.length > 0 ? member.position.join(', ') : 'None'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Instruments</div>
                                <div class="detail-value">${member.instruments && member.instruments.length > 0 ? member.instruments.join(', ') : 'None'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-address-card me-2"></i>Contact Information</h5>
                            <div class="detail-row">
                                <div class="detail-label">Phone Number</div>
                                <div class="detail-value">${member.phoneNo}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Residential Address</div>
                                <div class="detail-value">${member.residentialAddress}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('memberModal'));
                modal.show();
            }
        } catch (error) {
            console.error('Error loading member details:', error);
            showError('Failed to load member details');
        }
    }

    // Edit member
    async function editMember(memberId) {
        try {
            const response = await fetch(`/api/members/${memberId}`);
            const data = await response.json();
            
            if (data.success) {
                // Redirect to edit page or open edit modal
                // For now, we'll just show an alert with instructions
                alert(`Edit functionality for ${data.member.fullName} would open here.\n\nIn a full implementation, this would open a pre-filled form for editing.`);
            }
        } catch (error) {
            console.error('Error loading member for edit:', error);
            showError('Failed to load member for editing');
        }
    }

    // Delete member
    async function deleteMember(memberId) {
        if (!confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/members/${memberId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('Member deleted successfully!');
                loadMembers(currentPage);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error deleting member:', error);
            showError('Failed to delete member: ' + error.message);
        }
    }

    // Print member
    function printMember(memberId) {
        // Open member details in a new window for printing
        window.open(`/api/members/${memberId}?print=true`, '_blank');
    }

    // Utility functions
    function showSuccess(message) {
        alert('✅ ' + message); // In a real app, use a toast notification
    }

    function showError(message) {
        alert('❌ ' + message); // In a real app, use a toast notification
    }

    // Filter by zone
    function filterByZone() {
        searchMembers();
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchMembers();
        }
    });

    // View all members in table format with serial numbers
async function viewAllMembers() {
    try {
        const response = await fetch('/api/members/all');
        const data = await response.json();
        
        if (data.success) {
            const members = data.members;
            const tableBody = document.getElementById('allMembersTableBody');
            const totalCount = document.getElementById('totalMembersCount');
            
            totalCount.textContent = `Total Members: ${members.length}`;
            
            tableBody.innerHTML = members.map((member, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${member.fullName}</strong></td>
                    <td>${member.phoneNo}</td>
                    <td>${member.zone}</td>
                    <td>${member.area}</td>
                    <td>${member.parish}</td>
                    <td><span class="badge badge-primary">${member.part}</span></td>
                    <td>${member.joinYear}</td>
                    <td>${member.gender}</td>
                    <td>${member.occupation}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewMemberDetails('${member._id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning mx-1" onclick="editMember('${member._id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${member._id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const modal = new bootstrap.Modal(document.getElementById('viewAllModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading all members:', error);
        showError('Failed to load all members');
    }
}

// Print all members in table format
function printAllMembers() {
    const printWindow = window.open('', '_blank');
    const membersTable = document.getElementById('allMembersTable').cloneNode(true);
    
    // Remove action buttons from print version
    const actionCells = membersTable.querySelectorAll('td:last-child');
    actionCells.forEach(cell => cell.remove());
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Choir Members Report</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.6;
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 30px; 
                    border-bottom: 2px solid #333; 
                    padding-bottom: 20px; 
                }
                .header h1 { 
                    color: #333; 
                    margin: 0; 
                    font-size: 24px;
                }
                .header p { 
                    color: #666; 
                    margin: 5px 0; 
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    font-size: 14px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 10px;
                    text-align: left;
                }
                th {
                    background-color: #667eea;
                    color: white;
                    font-weight: bold;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .badge {
                    background: #667eea;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>CHOIR MEMBERS REPORT</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                <p>Total Members: ${document.getElementById('allMembersTableBody').children.length}</p>
            </div>
            ${membersTable.outerHTML}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Export to PDF
function exportToPDF() {
    window.open('/api/members/export/pdf', '_blank');
}

// Export to CSV (Excel)
function exportToCSV() {
    window.open('/api/members/export/csv', '_blank');
}
</script>
</body>
</html>